Read PHASE2-IMPLEMENTATION-PLAN-v2.md for the complete spec. Read heartbeat.md and CLAUDE.md for context and identity. Implement 4 workstreams in order: WS1, WS2, WS3, WS4. CRITICAL RULES: 1) GrammarEngine computes on-demand, NOTHING stored in DocumentProfile or DB. 2) HTML/PDF pipeline goes in mirrorDocToKnowledge.ts, NOT addUrlToKnowledgeAction.ts. 3) Section detection computed lazily in handler, NOT stored in DB. 4) No new count_occurrences mode, use search_all with countOnly flag on InferredMode. 5) Compound requests return ONE ActionResult with combined text. 6) Pin unpdf at 0.11.5 for Bun compat. 7) Fix nth mode paragraph/line, every branch must return respond() immediately, no mode mutation fallthrough. 8) Section routing at Priority 5.5 BEFORE last_paragraph at P7, remove conclusion from P7 and P9 patterns. 9) Update existing test the conclusion to last_paragraph to expect section. Install deps first: bun add linkedom unpdf@0.11.5. After all WS: bun run build (0 errors), npx vitest run (all pass), update heartbeat.md.
