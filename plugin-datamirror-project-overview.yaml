project_snapshot:
  name: "@elizaos/plugin-datamirror"
  version: "0.1.0"
  status: "Pre-integration snapshot (code written, needs Eliza monorepo wiring + local testing)"
  last_updated: "2026-01-23"
  scope:
    in_scope:
      - "ElizaOS plugin that lets an agent conversationally add public documents into Knowledge"
      - "Automatically keeps those documents up-to-date by checking source currency and re-ingesting when changed"
      - "Uses Eliza's Knowledge plugin for chunking/embeddings/storage (no parallel vector store)"
      - "Version tracking + safety controls (size policy, refresh policy) configurable via conversation"
      - "Background reconciliation worker that runs after startup (avoids slowing agent boot)"
    out_of_scope:
      - "Non-Eliza standalone runtime"
      - "Custom embeddings pipeline separate from Knowledge"
      - "Cloud-specific deployment steps"

purpose_and_design:
  purpose_statement: >
    Provide a seamless, conversational workflow for users to add and maintain
    complex Knowledge sources in an ElizaOS agent. The plugin mirrors public data
    into the agentâ€™s Knowledge and keeps it current via version detection and
    background reconciliation.
  key_concepts:
    publicspace: "Publicly accessible documents on the web (docs sites, markdown, lists of URLs)."
    mirrored_knowledge: "Documents ingested into Eliza Knowledge via KnowledgeService.addKnowledge()."
    currency_check: "Detect change using file list + HEAD metadata (etag/last-modified/size) and computed hash."
    versioning: "Track per-source versions; only latest active is logically current; older versions may be archived."
    safety_policies:
      size_policy: "Preview/auto-ingest threshold + hard cap (prevents data glut)."
      refresh_policy: "Preview cache TTL + reconcile cooldown + concurrency + startup timeout."
  user_roles:
    creator: "Agent builder who installs the plugin and shares the auth token if desired."
    user: "End user who interacts with the agent and can add sources / update policies with the token."
  permissions_model:
    mechanism: "Auth token required for conversational WRITE actions (token shared out-of-band)."
    defaults:
      - "Write actions require token"
      - "Read-only interaction does not require token"
    note: "Token validation is stubbed and must be finalized (see remaining_work)."

architecture:
  high_level_flow:
    startup:
      - "DatamirrorService starts with agent runtime"
      - "Reads datamirror settings (sources + initial policies) from character settings"
      - "Upserts size policy + refresh policy into DB"
      - "Schedules background reconciliation kickoff shortly after startup (non-blocking)"
    runtime_actions:
      - "User can add a single URL into Knowledge"
      - "User can mirror a source (docs site/list) into Knowledge"
      - "User can update size and refresh policies conversationally"
    background_reconciliation:
      - "Worker periodically checks sources"
      - "Runs discovery (llms.txt/llms-full.txt/sitemap/single URL)"
      - "Builds a preview (HEAD metadata + estimated total size)"
      - "Computes version hash and compares to latest active"
      - "If changed: ingests docs via Knowledge plugin; updates version + link tables"
      - "On failures: exponential backoff and keep last known good version"
  components:
    services:
      - "HttpService: fetch + getText"
      - "GithubService: Octokit client (stubbed for future GitHub discovery)"
      - "DatamirrorService: plugin service that seeds config and triggers startup bootstrap"
    orchestrator:
      - "StartupBootstrapService: logs + schedules background worker kickoff"
      - "ReconciliationWorker: concurrency throttling + cooldown + exponential backoff"
      - "ReconciliationService: preview + version detection + ingest + DB updates"
      - "previewSourceFiles: produces SourcePreview from Discovery + HEAD requests"
    publicspace_discovery:
      supported:
        - "LlmsTxtDiscovery: fetch root/llms.txt -> list of URLs"
        - "LlmsFullListDiscovery: fetch llms-full.txt -> list of URLs"
        - "SingleUrlDiscovery: treat input as one file"
      partial_or_stubbed:
        - "SitemapDiscovery: currently stubbed (returns empty); needs XML parsing"
      selection_order:
        - "Prefer llms.txt/llms-full.txt when pointing at site root"
        - "Fallback to sitemap.xml or single URL"
    knowledge_integration:
      approach: "All ingestion uses KnowledgeService.addKnowledge()"
      avoids_parallel_vector_store: true
      metadata_written:
        - "datamirror=true"
        - "sourceUrl=<original file url>"
        - "datamirrorSourceId=<source id>"
        - "datamirrorVersionId=<version hash>"
  data_model:
    db_owner: "Eliza SQL adapter / Drizzle via runtime.databaseAdapter.db"
    tables:
      datamirror_settings:
        purpose: "Per-agent size policy JSON"
        key_fields: ["agent_id (PK)", "size_policy_json"]
      datamirror_refresh_settings:
        purpose: "Per-agent refresh policy JSON"
        key_fields: ["agent_id (PK)", "refresh_policy_json"]
      datamirror_preview_cache:
        purpose: "Cache of last preview per source"
        key_fields: ["source_id (PK)", "preview_json", "checked_at"]
      datamirror_sources:
        purpose: "Registered sources"
        key_fields: ["id (PK)", "source_url", "enabled"]
      datamirror_versions:
        purpose: "Version records per source"
        key_fields: ["id (PK)", "source_id", "version_id", "status", "activated_at"]
      datamirror_knowledge_link:
        purpose: "Mapping from (source, version) to Knowledge document IDs"
        key_fields: ["id (PK)", "source_id", "version_id", "knowledge_document_id"]
    version_id_strategy:
      description: "sha256 over sorted file list entries (url, path, size, etag, last-modified)"
      benefit: "High-precision change detection without downloading full content"
      limitation: "If HEAD metadata is missing/incorrect, may miss changes or create false positives"

current_repo_state:
  plugin_folder: "plugin-datamirror"
  code_layout:
    src:
      entry:
        - "index.ts (plugin registration + schema export)"
        - "schema.ts (schema object export)"
      config:
        - "SizePolicy.ts"
        - "RefreshPolicy.ts"
      db:
        - "schema.ts (Drizzle tables)"
        - "*Repository.ts (CRUD wrappers)"
      services:
        - "httpService.ts"
        - "githubService.ts (Octokit stub)"
        - "datamirrorService.ts"
      orchestrator:
        - "StartupBootstrapService.ts"
        - "ReconciliationWorker.ts"
        - "ReconciliationService.ts"
        - "previewSource.ts"
        - "SourceConfig.ts"
      publicspace:
        - "UrlClassifier.ts"
        - "discoveryFactory.ts"
        - "LlmsTxtDiscovery.ts"
        - "LlmsFullListDiscovery.ts"
        - "SitemapDiscovery.ts (stub)"
        - "SingleUrlDiscovery.ts"
      integration:
        - "mirrorDocToKnowledge.ts"
      actions:
        - "ADD_URL_TO_KNOWLEDGE"
        - "MIRROR_SOURCE_TO_KNOWLEDGE"
        - "SET_DATAMIRROR_SIZE_POLICY"
        - "SET_DATAMIRROR_REFRESH_POLICY"
  known_local_issues:
    - id: "typo_in_folder_name"
      description: "One machine had src/intgegration; should be src/integration"
      status: "Must verify fixed in repo before build"
    - id: "sitemap_stub"
      description: "SitemapDiscovery returns empty; not functional yet"
      status: "Pending"

remaining_work:
  code_to_resolve:
    - id: "auth_token_validation"
      priority: "P0"
      description: >
        Implement real auth-token checks for write actions. Current actions treat token as accepted.
        Add a single canonical validator that checks env var DATAMIRROR_AUTH_TOKEN and/or optional DB override.
      files_affected:
        - "src/actions/*.ts"
        - "new: src/auth/validateToken.ts"
    - id: "size_policy_preview_gate"
      priority: "P0"
      description: >
        Enforce preview/threshold logic in MIRROR_SOURCE_TO_KNOWLEDGE before ingestion:
        compute SourcePreview totalBytes, compare against policy, require confirmation path when above threshold.
        Current reconcile path ingests immediately.
      files_affected:
        - "src/actions/mirrorSourceToKnowledgeAction.ts"
        - "src/orchestrator/ReconciliationService.ts"
    - id: "sitemap_parsing"
      priority: "P1"
      description: "Implement XML sitemap parsing (including sitemap indexes) to produce URL list."
      files_affected:
        - "src/publicspace/SitemapDiscovery.ts"
    - id: "github_discovery"
      priority: "P1"
      description: >
        Implement GitHub repo discovery using Octokit:
        list files in repo tree, filter by allowed extensions, fetch raw content URLs.
      files_affected:
        - "src/services/githubService.ts"
        - "new: src/publicspace/GithubRepoDiscovery.ts"
        - "src/publicspace/UrlClassifier.ts"
        - "src/publicspace/discoveryFactory.ts"
    - id: "drizzle_where_helpers_consistency"
      priority: "P1"
      description: >
        Verify Drizzle query syntax against actual ElizaSQL adapter version.
        Ensure eq/and/desc usage matches installed drizzle-orm version and DB adapter export shape.
      files_affected:
        - "src/db/*.ts"
    - id: "room_id_entity_id_alignment"
      priority: "P1"
      description: >
        Confirm correct usage of roomId/entityId/worldId for Knowledge addKnowledge calls in real Eliza runtime.
        Replace fallback assumptions (defaultRoomId or source.id) with proper runtime/context values.
      files_affected:
        - "src/integration/mirrorDocToKnowledge.ts"
        - "src/orchestrator/ReconciliationService.ts"
  documentation_to_add:
    - "README.md with install/config/action usage"
    - "Examples: character JSON snippet + env vars"
  quality_hardening:
    - "Retention policy for old versions (max versions per source; pruning strategy)"
    - "Better error messaging in discovery paths (already partially present)"
    - "Unit tests for VersionResolver + preview + policy gating (Vitest/Jest)"

testing_plan:
  phase_1_smoke:
    goal: "Confirm plugin builds in Eliza monorepo and basic runtime behavior works"
    steps:
      - "Copy plugin into eliza/packages/plugin-datamirror"
      - "Install deps via bun install at monorepo root"
      - "Build monorepo"
      - "Run a dev agent with plugins: sql + openai + knowledge + datamirror"
      - "Confirm logs show datamirror startup + background reconcile scheduling"
  phase_2_functional:
    tests:
      - name: "Add single URL"
        action: "ADD_URL_TO_KNOWLEDGE"
        expected: "Doc appears in Knowledge; no errors; metadata contains datamirror flags"
      - name: "Mirror docs source from root"
        action: "MIRROR_SOURCE_TO_KNOWLEDGE"
        expected: "Discovery uses llms.txt/llms-full.txt, creates active version, writes knowledge links"
      - name: "Policy update"
        action: "SET_DATAMIRROR_*"
        expected: "DB policy rows updated; subsequent reconcile uses new values"
  phase_3_regression:
    goal: "Ensure no runaway ingestion and stable behavior over repeated runs"
    steps:
      - "Run reconcile twice with no remote changes; second run should be 'up-to-date'"
      - "Simulate remote change (point to different list or modify mock source) and confirm new version created"
      - "Verify backoff behavior on forced failures (invalid URL)"

implementation_plan:
  integration_into_eliza_monorepo:
    steps:
      - "Place plugin at packages/plugin-datamirror"
      - "Ensure workspace includes packages/*"
      - "Ensure plugin builds under monorepo tooling (bun)"
      - "Ensure plugin schema export is discovered by migration system"
  local_run_requirements:
    env_vars:
      required:
        - "DATABASE_URL"
        - "OPENAI_API_KEY (or another provider key depending on model plugin)"
      recommended:
        - "DATAMIRROR_AUTH_TOKEN"
        - "GITHUB_TOKEN (only for GitHub discovery later)"
  expected_first_success_criteria:
    - "Agent starts without plugin import/build errors"
    - "Datamirror startup logs appear"
    - "MIRROR_SOURCE_TO_KNOWLEDGE creates an active version and links docs"
    - "Knowledge contains ingested documents with datamirror metadata"
